---
title: "Music Perception: Stimuli profiles"
output: html_notebook
---

- Last checked: `r format(Sys.Date(), "%d-%b-%Y")`

I chose stimuli with the IOIs within 2sd randomly from each condition (teaching, performing), each technique (articulation, dynamics).

Note: SubNr 3 was excluded due to insufficient motor skills (see analysis for [music-teaching: experiment-2](https://github.com/atsukotominaga/music-teaching/tree/main/experiment-2))

# DVs
- IOIs (average tempo)
- Transition points
- CV (tempo variability)
- KOR (articulation)
- KV (dynamics)
- KV-diff (dynamics)

```{r filtering, include = FALSE}
foldername = paste(format(Sys.time(), "%s-%d%m%y"), "/", sep = "") # current time

# create folders if not exists
if (!file.exists(foldername)){
  dir.create(foldername)
  dir.create(paste(foldername, "practice", sep = ""))
}

if (!file.exists(paste(foldername, "art_teaching", sep = ""))){
  dir.create(paste(foldername, "art_teaching", sep = ""))
  dir.create(paste(foldername, "practice/art_teaching", sep = ""))
}

if (!file.exists(paste(foldername, "dyn_teaching", sep = ""))){
  dir.create(paste(foldername, "dyn_teaching", sep = ""))
  dir.create(paste(foldername, "practice/dyn_teaching", sep = ""))
}

if (!file.exists(paste(foldername, "art_performing"))){
  dir.create(paste(foldername, "art_performing", sep = ""))
  dir.create(paste(foldername, "practice/art_performing", sep = ""))
}

if (!file.exists(paste(foldername, "dyn_performing"))){
  dir.create(paste(foldername, "dyn_performing", sep = ""))
  dir.create(paste(foldername, "practice/dyn_performing", sep = ""))
}

# read functions
source("./function.R")

# read a text file for ideal performance
dt_ideal <- read.table("./ideal.txt")
colnames(dt_ideal) <- "Pitch"
dt_ideal$RowNr <- 1:nrow(dt_ideal)
setcolorder(dt_ideal, c(2, 1))

# create a list of data file names
lf <- list.files("./raw_data", pattern = "txt")

# create raw_data - merge all data files into one
raw_data <- data.table()
for (i in 1:length(lf)){
  data_i <- fread(file.path("./raw_data", lf[i]), header = F, sep = " ", dec = ".")
  raw_data <- rbind(raw_data, data_i)
}

# add column namesls
colnames(raw_data) <- c("NoteNr", "TimeStamp", "Pitch", "Velocity", "Key_OnOff", "Device", "Tempo", "SubNr", "BlockNr", "TrialNr", "Skill", "Condition", "Image")

# clean raw_data
raw_data$NoteNr <- as.numeric(gsub(",", "", raw_data$NoteNr))
raw_data$Image <- gsub(";", "", raw_data$Image)

# sort by SubNr, BlockNr, TrialNr
raw_data <- raw_data[order(raw_data$SubNr, raw_data$BlockNr, raw_data$TrialNr),]

# correct labelling (due to a labelling error of the original study)
# articulation
dt_a <- raw_data[grepl("stim_a", Image)]
# correct wrong labelling
dt_a$Skill <- "articulation"

# dynamics
dt_d <- raw_data[grepl("stim_d", Image)]
# correct wrong labelling
dt_d$Skill <- "dynamics"

# bind data frames for articulation and dynamics
dt_all <- rbind(dt_a, dt_d)

# raw_data without metronome
dt_all <- dt_all[Pitch != 31 & Pitch != 34]

# onset and offset
dt_onset <- dt_all[Key_OnOff == 1]
dt_offset <- dt_all[Key_OnOff == 0]

# 1. Detect error trials
dt_error_onset <- checker(dt_onset, dt_ideal)
dt_error_offset <- checker(dt_offset, dt_ideal)

# combine onset/offset
dt_error <- rbind(dt_error_onset, dt_error_offset)
dt_error$Duplicate <- duplicated(dt_error)

# exclude error performances
dt_exclude <- dt_error[Duplicate == FALSE]

# mark imperfect performances
dt_all$Error <- 0
for (error in 1:nrow(dt_exclude)){
  dt_all[SubNr == dt_exclude$SubNr[error] & BlockNr == dt_exclude$BlockNr[error] & TrialNr == dt_exclude$TrialNr[error]]$Error <- 1
}
dt_include <- dt_all[Error == 0]

# exclude IOIs +/- 3SD
dt_ioi <- dt_include[Key_OnOff == 1]
dt_ioi$IOI <- diff(c(0, dt_ioi$TimeStamp))
dt_ioi <- dt_ioi[NoteNr != 17] # remove irrelevant notes
dt_ioi$Interval <- rep(1:71, nrow(dt_ioi)/71)

# convert bpm to ms
dt_ioi[Tempo == 120]$Tempo <- 250
dt_ioi[Tempo == 110]$Tempo <- 273
dt_ioi[Tempo == 100]$Tempo <- 300

# normalise IOIs
dt_ioi$normIOI <- dt_ioi$IOI/dt_ioi$Tempo

ioi <- dt_ioi[Interval != 25 & Interval != 26 & Interval != 27 & Interval != 28 & Interval != 32 & Interval != 33 & Interval != 34 & Interval != 35 & Interval != 51 & Interval != 52 & Interval != 56 & Interval != 57 & Interval != 65 & Interval != 66 & Interval != 67 & Interval != 68 & Interval != 69 & Interval != 70 & Interval != 71, .(N = .N, Mean = mean(normIOI), SD = sd(normIOI)), by = .(SubNr, BlockNr, TrialNr)]
mean_ioi <- mean(ioi$Mean)
sd_ioi <- sd(ioi$Mean)
ioi_include <- ioi[Mean < mean_ioi+2*sd_ioi & Mean > mean_ioi-2*sd_ioi]

dt_include_updated <- data.table()
for (row in 1:nrow(ioi_include)){
  subnr = ioi_include$SubNr[row]
  block = ioi_include$BlockNr[row]
  trial = ioi_include$TrialNr[row]
  
  current <- dt_include[SubNr == subnr & BlockNr == block & TrialNr == trial]
  dt_include_updated <- rbind(dt_include_updated, current)
}
```

```{r selection, include = FALSE}
# create a list for included performances
list_include <- dt_include_updated[, .N, by = .(SubNr, BlockNr, TrialNr, Condition, Skill)]
list_overall <- list_include[, .N, by = .(Condition, Skill)]

# assign random numbers for performances in each category
list_include$RandNr <- 0
for (cond in c("teaching", "performing")){
  for (skill in c("articulation", "dynamics")){
    list_include[Condition == cond & Skill == skill]$RandNr <- sample(nrow(list_include[Condition == cond & Skill == skill]), replace = FALSE)
  }
}
list_include <- list_include[order(RandNr),]
# stimuli for experimental trials
for (i in 1:96){ # 24 stimuli for each category
  subject = list_include$SubNr[i]
  block = list_include$BlockNr[i]
  trial = list_include$TrialNr[i]
  cond = list_include$Condition[i]
  skill = list_include$Skill[i]
  current <- dt_include[SubNr == subject & BlockNr == block & TrialNr == trial]
  firstTimestamp = current$TimeStamp[1]
  current$TimeStamp <- current$TimeStamp - firstTimestamp # start with time 0
  
  if (cond == "teaching" & skill == "articulation"){
    filename = paste(foldername, "art_teaching/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "teaching" & skill == "dynamics"){
    filename = paste(foldername, "dyn_teaching/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "performing" & skill == "articulation"){
    filename = paste(foldername, "art_performing/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "performing" & skill == "dynamics"){
    filename = paste(foldername, "dyn_performing/", subject, block, trial, ".txt", sep = "")
  }
  fwrite(current, file = filename)
}

print("Experimental stimuli - Done! :)")

# stimuli for practice trials
for (i in 97:104){ # 4 stimuli for each category
  subject = list_include$SubNr[i]
  block = list_include$BlockNr[i]
  trial = list_include$TrialNr[i]
  cond = list_include$Condition[i]
  skill = list_include$Skill[i]
  current <- dt_include[SubNr == subject & BlockNr == block & TrialNr == trial]
  firstTimestamp = current$TimeStamp[1]
  current$TimeStamp <- current$TimeStamp - firstTimestamp # start with time 0
  
  if (cond == "teaching" & skill == "articulation"){
    filename = paste(foldername, "practice/art_teaching/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "teaching" & skill == "dynamics"){
    filename = paste(foldername, "practice/dyn_teaching/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "performing" & skill == "articulation"){
    filename = paste(foldername, "practice/art_performing/", subject, block, trial, ".txt", sep = "")
  } else if (cond == "performing" & skill == "dynamics"){
    filename = paste(foldername, "practice/dyn_performing/", subject, block, trial, ".txt", sep = "")
  }
  fwrite(current, file = filename)
}

print("Practice stimuli - Done! :)")
```

```{r stimuli, include = FALSE}
rm(list = ls()) # clear all

# packages
if (!require("data.table")) {install.packages("data.table"); require("data.table")}
if (!require("ggpubr")) {install.packages("ggpubr"); require("ggpubr")}

# create a list of data file names
lf_a_t <- list.files("./1613936591-210221/art_teaching", pattern = "txt")
lf_a_p <- list.files("./1613936591-210221/art_performing", pattern = "txt")
lf_d_t <- list.files("./1613936591-210221/dyn_teaching", pattern = "txt")
lf_d_p <- list.files("./1613936591-210221/dyn_performing", pattern = "txt")

# merge all data files into one
data <- data.table()
for (i in 1:length(lf_a_t)){
 data_i <- fread(file.path("./1613936591-210221/art_teaching", lf_a_t[i]), header = T, sep = ",", dec = ".")
 data_i$Instance <- i
 data <- rbind(data, data_i)
}
for (i in 1:length(lf_a_p)){
 data_i <- fread(file.path("./1613936591-210221/art_performing", lf_a_p[i]), header = T, sep = ",", dec = ".")
 data_i$Instance <- i
 data <- rbind(data, data_i)
}
for (i in 1:length(lf_d_t)){
 data_i <- fread(file.path("./1613936591-210221/dyn_teaching", lf_d_t[i]), header = T, sep = ",", dec = ".")
 data_i$Instance <- i
 data <- rbind(data, data_i)
}
for (i in 1:length(lf_d_p)){
 data_i <- fread(file.path("./1613936591-210221/dyn_performing", lf_d_p[i]), header = T, sep = ",", dec = ".")
 data_i$Instance <- i
 data <- rbind(data, data_i)
}

# define subcomponents
# for intervals
ls_legato <- list(c(1:4), c(9:16), c(21:24), c(40:46))
ls_staccato <- list(c(6:7), c(18:19), c(29:31), c(36:38), c(48:50), c(53:55), c(58:64))
ls_forte <- list(c(1:4), c(9:16), c(21:24), c(40:46))
ls_piano <- list(c(6:7), c(18:19), c(29:31), c(36:38), c(48:50), c(53:55), c(58:64))

# for each note (velocity)
ls_legato2 <- list(c(1:5), c(9:17), c(21:26), c(40:47))
ls_staccato2 <- list(c(6:8), c(18:20), c(29:32), c(36:39), c(48:51), c(53:56), c(58:65))
ls_forte2 <- list(c(1:5), c(9:17), c(21:26), c(40:47))
ls_piano2 <- list(c(6:8), c(18:20), c(29:32), c(36:39), c(48:51), c(53:56), c(58:65))

# define Component Change (LtoS, FtoP)
change_1 <- c(5, 17, 47)
# define Component Change (StoL, PtoF)
change_2 <- c(8, 20, 39)
```

# IOIs
```{r ioi, include = FALSE}
data_onset <- data[Key_OnOff == 1]
data_offset <- data[Key_OnOff == 0]

data_onset$IOI <- diff(c(0, data_onset$TimeStamp))
dt_ioi <- data_onset[NoteNr != 17]
dt_ioi$Interval <- rep(1:71, nrow(dt_ioi)/71)

# convert bpm to ms
dt_ioi[Tempo == 120]$Tempo <- 250
dt_ioi[Tempo == 110]$Tempo <- 273
dt_ioi[Tempo == 100]$Tempo <- 300

# normalise IOIs
dt_ioi$normIOI <- dt_ioi$IOI/dt_ioi$Tempo

# assign Subcomponents
dt_ioi$Subcomponent <- "NA"
# Legato
for (phrase in 1:length(ls_legato)){
 for (note in 1:length(ls_legato[[phrase]])){
   dt_ioi[Skill == "articulation" & Interval == ls_legato[[phrase]][note]]$Subcomponent <- "Legato"
 }
}
# Staccato
for (phrase in 1:length(ls_staccato)){
 for (note in 1:length(ls_staccato[[phrase]])){
   dt_ioi[Skill == "articulation" & Interval == ls_staccato[[phrase]][note]]$Subcomponent <- "Staccato"
 }
}

# Forte
for (phrase in 1:length(ls_forte)){
 for (note in 1:length(ls_forte[[phrase]])){
   dt_ioi[Skill == "dynamics" & Interval == ls_forte[[phrase]][note]]$Subcomponent <- "Forte"
 }
}
# Piano
for (phrase in 1:length(ls_piano)){
 for (note in 1:length(ls_piano[[phrase]])){
   dt_ioi[Skill == "dynamics" & Interval == ls_piano[[phrase]][note]]$Subcomponent <- "Piano"
 }
}

# assign Subcomponent Change
for (number in change_1){
 dt_ioi[Skill == "articulation" & Interval == number]$Subcomponent <- "LtoS"
 dt_ioi[Skill == "dynamics" & Interval == number]$Subcomponent <- "FtoP"
}
for (number in change_2){
 dt_ioi[Skill == "articulation" & Interval == number]$Subcomponent <- "StoL"
 dt_ioi[Skill == "dynamics" & Interval == number]$Subcomponent <- "PtoF"
}

ioi <- dt_ioi[Subcomponent != "NA", .(N = .N, Mean = mean(normIOI), SD = sd(normIOI)), by = .(Instance, Condition, Skill)]
```

## Each instance
```{r ioi-each, echo = FALSE}
ioi
```

## Averaged
```{r ioi-averaged, echo = FALSE}
ioi[, .(N = .N, Mean = mean(Mean), SD = sd(Mean)), .(Condition, Skill)]
```

## Plot
```{r plot-ioi, echo = FALSE}
ggboxplot(ioi, x = "Condition", y = "Mean", color = "Condition", facet.by = "Skill", add = "jitter")
```

# KOR
```{r kor, include = FALSE}
data_onset$KOT <- NA
for (row in 1:nrow(data_onset)){
   if (row < nrow(data_onset)){
      data_onset$KOT[row+1] <- data_offset$TimeStamp[row] - data_onset$TimeStamp[row+1] # offset(n) - onset(n+1)
   }
}

ioi_forKOT <- dt_ioi[Subcomponent != "NA", .(N = .N, Mean = mean(IOI), SD = sd(IOI)), by = .(Instance, Condition, Skill)]

data_onset$KOR <- 0
for (cond in c("teaching", "performing")){
  for (skill in c("articulation", "dynamics")){
    for (i in c(1:24)){
      data_onset[Condition == cond & Skill == skill & Instance == i]$KOR <- data_onset[Condition == cond & Skill == skill & Instance == i]$KOT/ioi_forKOT[Condition == cond & Skill == skill & Instance == i]$Mean
    }
  }
}

dt_kor <- data_onset[NoteNr != 17]
dt_kor$Interval <- rep(1:71, nrow(dt_kor)/71)

# assign Subcomponents
dt_kor$Subcomponent <- "NA"
# Legato
for (phrase in 1:length(ls_legato)){
   for (note in 1:length(ls_legato[[phrase]])){
     dt_kor[Skill == "articulation" & Interval == ls_legato[[phrase]][note]]$Subcomponent <- "Legato"
   }
}
# Staccato
for (phrase in 1:length(ls_staccato)){
   for (note in 1:length(ls_staccato[[phrase]])){
     dt_kor[Skill == "articulation" & Interval == ls_staccato[[phrase]][note]]$Subcomponent <- "Staccato"
   }
}

# Forte
for (phrase in 1:length(ls_forte)){
   for (note in 1:length(ls_forte[[phrase]])){
     dt_kor[Skill == "dynamics" & Interval == ls_forte[[phrase]][note]]$Subcomponent <- "Forte"
   }
}
# Piano
for (phrase in 1:length(ls_piano)){
   for (note in 1:length(ls_piano[[phrase]])){
     dt_kor[Skill == "dynamics" & Interval == ls_piano[[phrase]][note]]$Subcomponent <- "Piano"
   }
}

# assign Subcomponent Change
for (number in change_1){
   dt_kor[Skill == "articulation" & Interval == number]$Subcomponent <- "LtoS"
   dt_kor[Skill == "dynamics" & Interval == number]$Subcomponent <- "FtoP"
}
for (number in change_2){
   dt_kor[Skill == "articulation" & Interval == number]$Subcomponent <- "StoL"
   dt_kor[Skill == "dynamics" & Interval == number]$Subcomponent <- "PtoF"
}

kor <- dt_kor[Subcomponent != "NA" & Subcomponent != "LtoS" & Subcomponent != "StoL" & Subcomponent != "FtoP" & Subcomponent != "PtoF", .(N = .N, Mean = mean(KOR), SD = sd(KOR)), by = .(Instance, Condition, Skill, Subcomponent)]
```

## Each instance
```{r kor-each, echo = FALSE}
kor
```

## Averaged
```{r kor-averaged, echo = FALSE}
kor[, .(N = .N, Mean = mean(Mean), SD = sd(Mean)), .(Condition, Skill, Subcomponent)]
```

## Plot
### Articulation
```{r plot-kor-art, echo = FALSE}
ggboxplot(kor[Skill == "articulation"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```

### Dynamics
```{r plot-kor-dyn, echo = FALSE}
ggboxplot(kor[Skill == "dynamics"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```

# KV
```{r vel, include = FALSE}
dt_vel <- data_onset
dt_vel$Note <- rep(1:72, nrow(dt_vel)/72)

# assign Subcomponents
dt_vel$Subcomponent <- "NA"
# Legato
for (phrase in 1:length(ls_legato2)){
   for (note in 1:length(ls_legato2[[phrase]])){
     dt_vel[Skill == "articulation" & Note == ls_legato2[[phrase]][note]]$Subcomponent <- "Legato"
   }
}
# Staccato
for (phrase in 1:length(ls_staccato2)){
   for (note in 1:length(ls_staccato2[[phrase]])){
     dt_vel[Skill == "articulation" & Note == ls_staccato2[[phrase]][note]]$Subcomponent <- "Staccato"
   }
}

# Forte
for (phrase in 1:length(ls_forte2)){
   for (note in 1:length(ls_forte2[[phrase]])){
     dt_vel[Skill == "dynamics" & Note == ls_forte2[[phrase]][note]]$Subcomponent <- "Forte"
   }
}

# Piano
for (phrase in 1:length(ls_piano2)){
   for (note in 1:length(ls_piano2[[phrase]])){
     dt_vel[Skill == "dynamics" & Note == ls_piano2[[phrase]][note]]$Subcomponent <- "Piano"
   }
}

vel <- dt_vel[Subcomponent != "NA", .(N = .N, Mean = mean(Velocity), SD = sd(Velocity)), by = .(Instance, Condition, Skill, Subcomponent)]
```

## Each instance
```{r vel-each, echo = FALSE}
vel
```

## Averaged
```{r vel-averaged, echo = FALSE}
vel[, .(N = .N, Mean = mean(Mean), SD = sd(Mean)), .(Condition, Skill, Subcomponent)]
```

## Plot
### Dynamics
```{r plot-vel-dyn, echo = FALSE}
ggboxplot(vel[Skill == "dynamics"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```

### Articulation
```{r plot-vel-art, echo = FALSE}
ggboxplot(vel[Skill == "articulation"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```

# KV-Diff
```{r vel-diff, include = FALSE}
# calculate differences and remove the first note
dt_vel$Diff <- diff(c(0, dt_vel$Velocity))
dt_vel_diff <- dt_vel[Note != 1]
dt_vel$Diff <- NULL # remove Diff from dt_vel

# assign Interval
dt_vel_diff$Interval <- rep(1:71, nrow(dt_vel_diff)/71)

# assign Subcomponents
dt_vel_diff$Subcomponent <- "NA"
# Legato
for (phrase in 1:length(ls_legato)){
for (note in 1:length(ls_legato[[phrase]])){
  dt_vel_diff[Skill == "articulation" & Interval == ls_legato[[phrase]][note]]$Subcomponent <- "Legato"
}
}
# Staccato
for (phrase in 1:length(ls_staccato)){
for (note in 1:length(ls_staccato[[phrase]])){
  dt_vel_diff[Skill == "articulation" & Interval == ls_staccato[[phrase]][note]]$Subcomponent <- "Staccato"
}
}

# Forte
for (phrase in 1:length(ls_forte)){
for (note in 1:length(ls_forte[[phrase]])){
  dt_vel_diff[Skill == "dynamics" & Interval == ls_forte[[phrase]][note]]$Subcomponent <- "Forte"
}
}
# Piano
for (phrase in 1:length(ls_piano)){
for (note in 1:length(ls_piano[[phrase]])){
  dt_vel_diff[Skill == "dynamics" & Interval == ls_piano[[phrase]][note]]$Subcomponent <- "Piano"
}
}

# assign Subcomponent Change
for (i in change_1){
dt_vel_diff[Skill == "articulation" & Interval == i]$Subcomponent <- "LtoS"
dt_vel_diff[Skill == "dynamics" & Interval == i]$Subcomponent <- "FtoP"
}
for (i in change_2){
dt_vel_diff[Skill == "articulation" & Interval == i]$Subcomponent <- "StoL"
dt_vel_diff[Skill == "dynamics" & Interval == i]$Subcomponent <- "PtoF"
}

vel_diff <- dt_vel_diff[Subcomponent == "LtoS" | Subcomponent == "StoL" | Subcomponent == "FtoP" | Subcomponent == "PtoF", .(N = .N, Mean = mean(Diff), SD = sd(Diff)), by = .(Instance, Condition, Skill, Subcomponent)]
```

## Each instance
```{r vel-diff-each, echo = FALSE}
vel_diff
```

## Averaged
```{r vel-diff-averaged, echo = FALSE}
vel_diff[, .(N = .N, Mean = mean(Mean), SD = sd(Mean)), .(Condition, Skill, Subcomponent)]
```

## Plot
### Dynamics
```{r plot-vel-diff-dyn, echo = FALSE}
ggboxplot(vel_diff[Skill == "dynamics"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```

### Articulation
```{r plot-vel-diff-art, echo = FALSE}
ggboxplot(vel_diff[Skill == "articulation"], x = "Condition", y = "Mean", color = "Condition", facet.by = "Subcomponent", add = "jitter")
```
